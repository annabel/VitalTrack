# ============================================================================
# Quality Gate — calls the reusable workflow for multiple checks
# Demonstrates: calling reusable workflows, using needs across called workflows
# ============================================================================
name: Quality Gate

on:
  workflow_dispatch:

jobs:
  lint:
    name: Lint
    uses: ./.github/workflows/reusable-setup.yml
    with:
      run-command: npm run lint

  typecheck:
    name: Typecheck
    uses: ./.github/workflows/reusable-setup.yml
    with:
      run-command: npx tsc -b --noEmit

  build:
    name: Build
    needs: [lint, typecheck]
    uses: ./.github/workflows/reusable-setup.yml
    with:
      run-command: npm run build

  report:
    name: Report
    runs-on: ubuntu-latest
    needs: [lint, typecheck, build]
    if: always()
    steps:
      - name: Generate report
        run: |
          echo "### Quality Gate Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Check | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Lint       | ${{ needs.lint.result == 'success' && '✅' || '❌' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Typecheck  | ${{ needs.typecheck.result == 'success' && '✅' || '❌' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Build      | ${{ needs.build.result == 'success' && '✅' || '❌' }} |" >> "$GITHUB_STEP_SUMMARY"
