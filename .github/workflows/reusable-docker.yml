# ============================================================================
# Reusable Workflow â€” Build & push Docker image
# Demonstrates: secrets, outputs (image digest), complex inputs
# ============================================================================
name: "(Reusable) Docker Build"

on:
  workflow_call:
    inputs:
      image-name:
        description: "Docker image name (without registry prefix)"
        required: true
        type: string
      registry:
        description: "Container registry to push to"
        required: false
        type: string
        default: "ghcr.io"
      dockerfile:
        description: "Path to Dockerfile"
        required: false
        type: string
        default: "./Dockerfile"
      context:
        description: "Docker build context"
        required: false
        type: string
        default: "."
      push:
        description: "Whether to push the built image"
        required: false
        type: boolean
        default: true
      platforms:
        description: "Target platforms (comma-separated)"
        required: false
        type: string
        default: "linux/amd64"
    secrets:
      registry-username:
        description: "Registry login username"
        required: false
      registry-password:
        description: "Registry login password/token"
        required: false
    outputs:
      image-ref:
        description: "Full image reference (registry/name:tag)"
        value: ${{ jobs.build.outputs.image-ref }}
      digest:
        description: "Image digest (sha256:...)"
        value: ${{ jobs.build.outputs.digest }}

jobs:
  build:
    name: "Build ${{ inputs.image-name }}"
    runs-on: ubuntu-latest

    outputs:
      image-ref: ${{ steps.meta.outputs.image-ref }}
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to registry
        if: inputs.push
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ secrets.registry-username || github.actor }}
          password: ${{ secrets.registry-password || github.token }}

      - name: Extract metadata
        id: meta
        run: |
          REF="${{ inputs.registry }}/${{ inputs.image-name }}"
          SHA="${{ github.sha }}"
          SHORT_SHA="${SHA:0:7}"
          echo "image-ref=${REF}:${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "tags=${REF}:${SHORT_SHA},${REF}:latest" >> "$GITHUB_OUTPUT"

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          push: ${{ inputs.push }}
          tags: ${{ steps.meta.outputs.tags }}
          platforms: ${{ inputs.platforms }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          echo "### ðŸ³ Docker Build" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Field | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Image | \`${{ steps.meta.outputs.image-ref }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Pushed | ${{ inputs.push }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Platforms | ${{ inputs.platforms }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Digest | \`${{ steps.build.outputs.digest || 'n/a' }}\` |" >> "$GITHUB_STEP_SUMMARY"
