# ============================================================================
# PR Automation â€” label, comment, and validate pull requests
# Demonstrates: PR events, labeler, context expressions, job outputs
# ============================================================================
name: PR Automation

on:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled]

permissions:
  contents: read
  pull-requests: write

jobs:
  # ---------- Auto-label by file paths ----------
  label:
    name: Auto-label
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'synchronize'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          sync-labels: true

  # ---------- Size label ----------
  size:
    name: PR Size
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate diff size
        id: diff
        run: |
          ADDITIONS=$(gh pr view ${{ github.event.pull_request.number }} --json additions -q '.additions')
          DELETIONS=$(gh pr view ${{ github.event.pull_request.number }} --json deletions -q '.deletions')
          TOTAL=$((ADDITIONS + DELETIONS))
          echo "total=$TOTAL" >> "$GITHUB_OUTPUT"
          if [ "$TOTAL" -lt 10 ]; then SIZE="XS"
          elif [ "$TOTAL" -lt 50 ]; then SIZE="S"
          elif [ "$TOTAL" -lt 200 ]; then SIZE="M"
          elif [ "$TOTAL" -lt 500 ]; then SIZE="L"
          else SIZE="XL"
          fi
          echo "size=$SIZE" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Apply size label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ github.event.pull_request.number }} \
            --add-label "size/${{ steps.diff.outputs.size }}"

  # ---------- Welcome first-time contributors ----------
  welcome:
    name: Welcome
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Check if first-time contributor
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COUNT=$(gh api \
            "/repos/${{ github.repository }}/commits?author=${{ github.event.pull_request.user.login }}&per_page=1" \
            --jq 'length')
          echo "first_time=$( [ "$COUNT" -eq 0 ] && echo true || echo false )" >> "$GITHUB_OUTPUT"

      - name: Post welcome comment
        if: steps.check.outputs.first_time == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "ðŸ‘‹ Welcome to VitalTrack, @${{ github.event.pull_request.user.login }}! Thanks for your first contribution. A maintainer will review this shortly."
