# ============================================================================
# PR Build Report â€” build the PR branch, measure bundle size, and comment
# Demonstrates: comparing against base branch, PR comments, job summary
# ============================================================================
name: PR Build Report

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: pr-build-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  build-report:
    name: Build & Report
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - run: npm ci

      # Build the PR branch
      - name: Build PR branch
        run: npm run build

      - name: Measure PR bundle size
        id: pr
        run: |
          SIZE=$(du -sb dist/ | cut -f1)
          SIZE_KB=$(echo "scale=2; $SIZE / 1024" | bc)
          FILES=$(find dist/ -type f | wc -l | tr -d ' ')
          JS_SIZE=$(find dist/ -name '*.js' -exec du -cb {} + | tail -1 | cut -f1)
          JS_KB=$(echo "scale=2; ${JS_SIZE:-0} / 1024" | bc)
          CSS_SIZE=$(find dist/ -name '*.css' -exec du -cb {} + | tail -1 | cut -f1)
          CSS_KB=$(echo "scale=2; ${CSS_SIZE:-0} / 1024" | bc)
          echo "total=$SIZE" >> "$GITHUB_OUTPUT"
          echo "total_kb=$SIZE_KB" >> "$GITHUB_OUTPUT"
          echo "files=$FILES" >> "$GITHUB_OUTPUT"
          echo "js_kb=$JS_KB" >> "$GITHUB_OUTPUT"
          echo "css_kb=$CSS_KB" >> "$GITHUB_OUTPUT"

      # Build the base branch for comparison
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          clean: false
          path: __base

      - name: Build base branch
        id: base_build
        continue-on-error: true
        run: |
          cd __base
          npm ci
          npm run build
          echo "success=true" >> "$GITHUB_OUTPUT"

      - name: Measure base bundle size
        id: base
        if: steps.base_build.outputs.success == 'true'
        run: |
          SIZE=$(du -sb __base/dist/ | cut -f1)
          SIZE_KB=$(echo "scale=2; $SIZE / 1024" | bc)
          echo "total=$SIZE" >> "$GITHUB_OUTPUT"
          echo "total_kb=$SIZE_KB" >> "$GITHUB_OUTPUT"

      # Calculate diff
      - name: Calculate size diff
        id: diff
        run: |
          PR=${{ steps.pr.outputs.total }}
          BASE=${{ steps.base.outputs.total || '0' }}
          if [ "$BASE" -eq 0 ]; then
            echo "delta=N/A (no base build)" >> "$GITHUB_OUTPUT"
            echo "emoji=â„¹ï¸" >> "$GITHUB_OUTPUT"
          else
            DIFF=$((PR - BASE))
            DIFF_KB=$(echo "scale=2; $DIFF / 1024" | bc)
            PCT=$(echo "scale=1; ($DIFF * 100) / $BASE" | bc)
            if [ "$DIFF" -gt 0 ]; then
              echo "delta=+${DIFF_KB} KB (+${PCT}%)" >> "$GITHUB_OUTPUT"
              if [ "$DIFF" -gt 51200 ]; then
                echo "emoji=ðŸ”´" >> "$GITHUB_OUTPUT"
              else
                echo "emoji=ðŸŸ¡" >> "$GITHUB_OUTPUT"
              fi
            elif [ "$DIFF" -lt 0 ]; then
              echo "delta=${DIFF_KB} KB (${PCT}%)" >> "$GITHUB_OUTPUT"
              echo "emoji=ðŸŸ¢" >> "$GITHUB_OUTPUT"
            else
              echo "delta=No change" >> "$GITHUB_OUTPUT"
              echo "emoji=âšª" >> "$GITHUB_OUTPUT"
            fi
          fi

      # Post or update a PR comment
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- pr-build-report -->';
            const body = [
              marker,
              '### ðŸ“¦ Build Report',
              '',
              '| Metric | Value |',
              '|--------|-------|',
              `| Total size | **${{ steps.pr.outputs.total_kb }} KB** |`,
              `| JS size | ${{ steps.pr.outputs.js_kb }} KB |`,
              `| CSS size | ${{ steps.pr.outputs.css_kb }} KB |`,
              `| Files | ${{ steps.pr.outputs.files }} |`,
              `| Î” vs base | ${{ steps.diff.outputs.emoji }} ${{ steps.diff.outputs.delta }} |`,
              '',
              `<sub>Built from ${{ github.event.pull_request.head.sha }}</sub>`
            ].join('\n');

            // Find existing comment to update
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const existing = comments.find(c => c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Write summary
        run: |
          echo "### ðŸ“¦ Build Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Total | ${{ steps.pr.outputs.total_kb }} KB |" >> "$GITHUB_STEP_SUMMARY"
          echo "| JS | ${{ steps.pr.outputs.js_kb }} KB |" >> "$GITHUB_STEP_SUMMARY"
          echo "| CSS | ${{ steps.pr.outputs.css_kb }} KB |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Î” vs base | ${{ steps.diff.outputs.emoji }} ${{ steps.diff.outputs.delta }} |" >> "$GITHUB_STEP_SUMMARY"
