# ============================================================================
# Long name to test how GitHub Actions UI handles verbose workflow names
# ============================================================================
name: "Full Stack Integration Test Suite Across Multiple Node Versions with Database Migrations and API Contract Validation"

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  integration:
    name: "Integration (Node ${{ matrix.node }}, ${{ matrix.database }})"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        node: [20, 22]
        database: [postgres, sqlite]

    # Example: spin up services for real integration tests
    services:
      postgres:
        image: ${{ matrix.database == 'postgres' && 'postgres:16-alpine' || '' }}
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: vitaltrack_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: npm

      - run: npm ci

      - name: Run database migrations
        run: |
          echo "Running migrations against ${{ matrix.database }}..."
          # npx prisma migrate deploy
          # npx knex migrate:latest
          echo "âœ… Migrations complete"

      - name: Seed test data
        run: |
          echo "Seeding test database..."
          # npx prisma db seed
          echo "âœ… Test data seeded"

      - name: Run integration tests
        run: |
          echo "Running integration tests on Node ${{ matrix.node }} with ${{ matrix.database }}..."
          # npm run test:integration
          echo "âœ… All integration tests passed"
        env:
          DATABASE_URL: ${{ matrix.database == 'postgres' && 'postgresql://test:test@localhost:5432/vitaltrack_test' || 'sqlite://./test.db' }}
          NODE_ENV: test

      - name: Validate API contracts
        run: |
          echo "Validating API contracts (OpenAPI spec)..."
          # npx dredd api-spec.yml http://localhost:3000
          echo "âœ… All API contracts valid"

      - name: Summary
        run: |
          echo "### ðŸ§ª Integration Test Results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Parameter | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Node.js | ${{ matrix.node }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Database | ${{ matrix.database }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Migrations | âœ… |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Integration Tests | âœ… |" >> "$GITHUB_STEP_SUMMARY"
          echo "| API Contracts | âœ… |" >> "$GITHUB_STEP_SUMMARY"
