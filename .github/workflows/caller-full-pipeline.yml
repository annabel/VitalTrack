# ============================================================================
# Full Pipeline â€” chains all reusable workflows into a complete CI/CD pipeline
# Demonstrates: nesting, outputs between reusable workflows, matrix + reusable,
#               secrets: inherit, conditional job execution
# ============================================================================
name: "Caller: Full Pipeline"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  deployments: write

jobs:
  # â”€â”€ Lint & Typecheck (reusable-setup in parallel) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: Lint
    uses: ./.github/workflows/reusable-setup.yml
    with:
      run-command: npm run lint

  typecheck:
    name: Typecheck
    uses: ./.github/workflows/reusable-setup.yml
    with:
      run-command: npx tsc -b --noEmit

  # â”€â”€ Test across Node versions (matrix + reusable) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: "Test (Node ${{ matrix.node }})"
    strategy:
      fail-fast: false
      matrix:
        node: [20, 22]
    uses: ./.github/workflows/reusable-test.yml
    with:
      node-version: ${{ matrix.node }}
      coverage-threshold: 70

  # â”€â”€ Build (depends on lint + typecheck) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: Build
    needs: [lint, typecheck]
    uses: ./.github/workflows/reusable-setup.yml
    with:
      run-command: npm run build

  # â”€â”€ Deploy to staging (only on main, after build + tests pass) â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-staging:
    name: Deploy Staging
    needs: [build, test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      environment: staging
      artifact-name: ${{ needs.build.outputs.artifact-name }}
      url: "https://staging.vitaltrack.example.com"
    secrets: inherit

  # â”€â”€ Notify on completion â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify-success:
    name: Notify Success
    needs: [lint, typecheck, test, build, deploy-staging]
    if: success() && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/reusable-notify.yml
    with:
      status: success
      title: "Pipeline Complete"
      message: "All checks passed and staging deployed for `${{ github.sha }}`"
    secrets: inherit

  notify-failure:
    name: Notify Failure
    needs: [lint, typecheck, test, build]
    if: failure()
    uses: ./.github/workflows/reusable-notify.yml
    with:
      status: failure
      title: "Pipeline Failed"
      message: "One or more checks failed on `${{ github.ref_name }}` â€” ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      mention: "@oncall"
    secrets: inherit

  # â”€â”€ Pipeline report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  report:
    name: Pipeline Report
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test, build, deploy-staging]
    if: always()

    steps:
      - name: Generate report
        run: |
          echo "### ðŸ“Š Full Pipeline Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Stage | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Lint | ${{ needs.lint.result == 'success' && 'âœ…' || 'âŒ' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Typecheck | ${{ needs.typecheck.result == 'success' && 'âœ…' || 'âŒ' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Tests | ${{ needs.test.result == 'success' && 'âœ…' || 'âŒ' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ…' || 'âŒ' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Deploy Staging | ${{ needs.deploy-staging.result == 'success' && 'âœ…' || needs.deploy-staging.result == 'skipped' && 'â­ï¸ skipped' || 'âŒ' }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Ref:** \`${{ github.ref_name }}\` â€¢ **SHA:** \`${{ github.sha }}\`" >> "$GITHUB_STEP_SUMMARY"
